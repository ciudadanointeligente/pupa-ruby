<!DOCTYPE html>

<html>
<head>
  <title>legislator.rb</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bill.html">
                bill.rb
              </a>
            
              
              <a class="source" href="cat.html">
                cat.rb
              </a>
            
              
              <a class="source" href="legislator.html">
                legislator.rb
              </a>
            
              
              <a class="source" href="organization.html">
                organization.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>legislator.rb</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The <a href="http://opennorth.github.io/pupa-ruby/docs/cat.html">cat.rb</a> example goes
over the basics of using Pupa.rb, and <a href="http://opennorth.github.io/pupa-ruby/docs/bill.html">bill.rb</a>
covers how to relate objects and how to separate scraping tasks for different
types of data. This will explain how to run, for example, different methods to
scrape legislators depending on the legislative term - particularly useful if
a data source changes format from year to year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">require</span> <span class="string">'pupa'</span>

<span class="keyword">require</span> <span class="string">'nokogiri'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>parl.gc.ca uses ASP.NET forms, so we need <a href="http://mechanize.rubyforge.org/">bigger guns</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">require</span> <span class="string">'mechanize'</span>

<span class="class"><span class="keyword">class</span> <span class="title">LegislatorProcessor</span> <span class="inheritance">&lt; <span class="parent">Pupa::Processor</span></span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The data source publishes information from different parliaments in
different formats. We override <code>scraping_task_method</code> to select the method
used to scrape legislators according to the parliament.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">def</span> <span class="title">scraping_task_method</span><span class="params">(task_name)</span></span>
    <span class="keyword">if</span> task_name == <span class="symbol">:people</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If the task is to scrape people and a parliament is given, we select a
method according to the parliament.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="variable">@options</span>.key?(<span class="string">'parliament'</span>)
        <span class="keyword">if</span> <span class="variable">@options</span>[<span class="string">'parliament'</span>].to_i &gt;= <span class="number">36</span>
          <span class="string">"scrape_people_36th_to_date"</span>
        <span class="keyword">else</span>
          <span class="string">"scrape_people_1st_to_35th"</span>
        <span class="keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If no parliament is given, we assume the parliament is recent, as it is
more common to scrape current data than historical data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span>
        <span class="string">"scrape_people_36th_to_date"</span>
      <span class="keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Otherwise, we use <code>scraping_task_method</code>&#39;s default behavior for other
scraping tasks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span>
      <span class="keyword">super</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>A helper method to put name components in a typical order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="keyword">def</span> <span class="title">swap_first_last_name</span><span class="params">(name)</span></span>
    name.strip.match(<span class="regexp">/\A([^,]+?), ([^(]+?)(?: \(.+\))?\z/</span>)[<span class="number">1</span>..<span class="number">2</span>].
      reverse.map{|component| component.strip.squeeze(<span class="string">' '</span>)}.join(<span class="string">' '</span>)
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">def</span> <span class="title">scrape_people_36th_to_date</span></span>
    url = <span class="string">'http://www.parl.gc.ca/MembersOfParliament/MainMPsCompleteList.aspx?TimePeriod=Historical&amp;Language=E'</span>
    doc = <span class="keyword">if</span> <span class="variable">@options</span>.key?(<span class="string">'parliament'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Since we aren&#39;t using the default Faraday HTTP client, we manually
configure the Mechanize client to use Pupa.rb&#39;s logger.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      client = <span class="constant">Mechanize</span>.new
      client.log = <span class="constant">Pupa::Logger</span>.new(<span class="string">'mechanize'</span>, <span class="symbol">level:</span> <span class="variable">@level</span>)
      page = client.get(url)
      page.form[<span class="string">'MasterPage$MasterPage$BodyContent$PageContent$Content$ListCriteriaContent$ListCriteriaContent$ucComboParliament$cboParliaments'</span>] = <span class="variable">@options</span>[<span class="string">'parliament'</span>]
      page.form.submit.parser
    <span class="keyword">else</span>
      get(url)
    <span class="keyword">end</span>

    doc.css(<span class="string">'#MasterPage_MasterPage_BodyContent_PageContent_Content_ListContent_ListContent_grdCompleteList tr:gt(1)'</span>).each <span class="keyword">do</span> |row|
      person = <span class="constant">Pupa::Person</span>.new
      person.name = swap_first_last_name(row.at_css(<span class="string">'td:eq(1)'</span>).text)
      <span class="constant">Fiber</span>.<span class="keyword">yield</span>(person)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="function"><span class="keyword">def</span> <span class="title">scrape_people_1st_to_35th</span></span>
    list_url = <span class="string">'http://www.parl.gc.ca/Parlinfo/Lists/Members.aspx?Language=E'</span>
    page_url = <span class="string">'http://www.parl.gc.ca/Parlinfo/Lists/Members.aspx?Language=E&amp;Parliament=%s&amp;Riding=&amp;Name=&amp;Party=&amp;Province=&amp;Gender=&amp;New=False&amp;Current=False&amp;First=False&amp;Picture=False&amp;Section=False&amp;ElectionDate='</span>
    doc = get(list_url)
    value = doc.at_xpath(<span class="string">"//select[@id='ctl00_cphContent_cboParliamentCriteria']/option[starts-with(.,'<span class="subst">#{<span class="variable">@options</span>[<span class="string">'parliament'</span>]}</span>')]/@value"</span>).value
    doc = get(page_url % value)

    doc.css(<span class="string">'tr:gt(1)'</span>).each <span class="keyword">do</span> |row|
      person = <span class="constant">Pupa::Person</span>.new
      person.name = swap_first_last_name(row.at_css(<span class="string">'td:eq(1)'</span>).text)
      <span class="constant">Fiber</span>.<span class="keyword">yield</span>(person)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="constant">LegislatorProcessor</span>.add_scraping_task(<span class="symbol">:people</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>To add scraping method selection criteria when running the processor, call
<code>legislator.rb</code> following the pattern:</p>
<pre><code>ruby legislator.rb [options] -- [criteria]</code></pre>
<p>So, for example, to scrape and import legislators from the 37th parliament:</p>
<pre><code>ruby legislator.rb -- parliament 37</code></pre>
<p>Or, to scrape but not import legislators from the 12th parliament:</p>
<pre><code>ruby legislator.rb --action scrape -- parliament 12</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>runner = <span class="constant">Pupa::Runner</span>.new(<span class="constant">LegislatorProcessor</span>)
runner.run(<span class="constant">ARGV</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Tired of scraping and importing data? See <a href="http://opennorth.github.io/pupa-ruby/docs/organization.html">organization.rb</a>
to learn how to transform scraped data with Pupa.rb.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
